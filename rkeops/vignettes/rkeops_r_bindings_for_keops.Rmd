---
title: "RKeOps: R bindings for KeOps"
output: 
  rmarkdown::html_vignette:
    toc: true
  pdf_document:
    toc: true
    number_sections: yes
author: "Ghislain Durif"
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{RKeOps: R bindings for KeOps}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  progress = TRUE,
  warning = FALSE
)
```

# Install RKeOps

## Requirements

* R (tested with R >= 3.5)
* Cmake (>=3.10)
* C++ compiler (g++ >=7 or clang) for CPU computing or CUDA compiler (nvcc >=10) and CUDA libs for GPU computing

## Install from CRAN
(**not available at the moment**)
```{r install, eval=FALSE}
install.packages("rkeops")
```

## Install from sources

* Install directly from Github (requires `git`)
```{r install_github, eval=FALSE}
devtools::install_git("https://github.com/getkeops/keops", 
                      subdir = "rkeops", 
                      args="--recurse-submodules=\"keops/lib/sequences\"")
# not possible to use `devtools::intall_github()` because of the required submodule
```

## Get sources and install from local repository
* Get KeOps sources (bash command)
```bash
git clone --recurse-submodules="keops/lib/sequences" https://github.com/getkeops/keops
# or
git clone https://github.com/getkeops/keops
cd keops
git submodule update --init -- keops/lib/sequences
# other submodules are not necessary for RKeOps
```

* Install from source in R (assuming you are in the `keops` directory)
```{r install_src, eval=FALSE}
devtools::install("rkeops")
```

---

# Using RKeOps

```{r setup}
library(rkeops)
```

## Input matrix

You can use two type of input matrices with RKeOps:<br>

* ones whose rows (or columns) are indexed by $i=1,...,M$ such as $\mathbf X = [x_{ik}]_{M \times D}$<br>

* others whose rows (or columns) are indexed by $j=1,...,N$ such as $\mathbf Y = [y_{ik'}]_{N \times D'}$<br><br>

The dimensions over indexes $i$ or $j$ are called the **outer dimensions** (i.e. $M$ or $N$). The other dimensions (i.e. $D$ or $D'$) are called the **inner dimensions**. These terms refer to the contiguity of the data in memory:<br>

* **Outer dimensions** $M$ and $N$ (over indexes $i$ and $j$ respectively) can be **very large**, even to large for GPU memory.<br>

* **Inner dimensions** $D$ and $D'$ should be **small** enough to fit in GPU memory, in particular to ensure data colocality and avoid useless memory transfers. Corresponding columns (or rows) should be contiguous in memory (this point is handled for you in RKeOps).<br>

> **_Note 1:_** The outer dimension can correspond to the rows or the columns of the input matrices (and vice-versa for the inner dimension). The optimal orientation of input matrices is discussed [here](rkeops_r_bindings_for_keops.html#input-matrix) .

> **_Note 2:_** All matrices indexed by $i$ should have the same outer dimension over $i$ (i.e. $M$), same for all matrices indexed by $j$ (dimension $N$). Only the inner dimensions $D$ and $D'$ should be known for the compilation of your operators. The respective outer dimensions $M$ and $N$ are set at runtime (and can change from one run to another).<br>

### Data storage orientation

In R matrix are stored using a column-major